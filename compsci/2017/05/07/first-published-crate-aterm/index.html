<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>My first published crate: aterm</title>
    <meta name="description" content="A web log. Mostly about computer science-y stuff. 
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://blog.jeffsmits.net/compsci/2017/05/07/first-published-crate-aterm/">
    
    <link rel="stylesheet" type="text/css" href="/css/katex.min.css">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Whatever</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">My first published crate: aterm</h1>
    <p class="post-meta">May 7, 2017</p>
  </header>

  <article class="post-content">
    <p>I published my first crate to <a href="https://crates.io/">crates.io</a>! It’s called <a href="https://crates.io/crates/aterm"><code class="highlighter-rouge">aterm</code></a>, and it’s a library that implements the <u>A</u>nnotated <u>Term</u> format. Currently it can only parse and print the normal textual format, but I’m planning to add the other three formats too at some point. There are also a number of other improvements that I have planned. But I’m going to try to not make this post a brain-dump of meandering thoughts. So here’s what I’d like to discuss:</p>

<ul id="markdown-toc">
  <li><a href="#what-are-aterms" id="markdown-toc-what-are-aterms">What are ATerms</a></li>
  <li><a href="#why-implement-this" id="markdown-toc-why-implement-this">Why implement this</a></li>
  <li><a href="#the-implementation" id="markdown-toc-the-implementation">The implementation</a>    <ul>
      <li><a href="#highlights--things-i-learned" id="markdown-toc-highlights--things-i-learned">Highlights &amp; Things I learned</a></li>
    </ul>
  </li>
  <li><a href="#what-happened-to-automata" id="markdown-toc-what-happened-to-automata">What happened to automata?</a></li>
</ul>

<h1 id="what-are-aterms">What are ATerms</h1>

<p>The Annotated Term format<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> originates from the <a href="https://www.cwi.nl/about">Centre for Mathematics and Computer Science (CWI)</a> in Amsterdam. It describes trees and annotations on those trees. The big features are maximal sharing (subtrees that are the same are only allocated once), a compressed binary format, and a C implementation that does garbage collection. The format dates back to around 2000.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Add(Int("1"){Value(1)}, Int("2"){Value(2)}){Value(3)}
</code></pre>
</div>

<p>(^A small tree describing addition of two numbers, with annotations on each “application” with the value)</p>

<p>The ATerm format was used by a number of tools in a number of research groups as an exchange format (and they probably also used the library implementations to provide the internal representation as well). Maximal sharing was super fancy, although recently research was published that this maximal sharing can in many situations be more overhead than optimisation. <sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup> The compressed formats allowed pretty quick communication between different tools that sometimes explicitly held on to the <a href="https://en.wikipedia.org/wiki/Unix_philosophy">Unix philosophy</a>.</p>

<p>For those of you who are interested in implementations of this format in other languages, have a look at the <a href="https://github.com/cwi-swat/aterms">CWI repository</a>, which includes implementations in C, Java and C#.</p>

<h1 id="why-implement-this">Why implement this</h1>

<p>As mentioned in the high-level description above, this was used by a number of tools created by researchers as an exchange format. I actually use this format myself at TU Delft. So I figured I could combine my wish to learn more Rust and performance engineering, with some of the knowledge I have about ageing tools I use!</p>

<p>In particular, I’m currently working on an interpreter, written in Rust, that executes Stratego Core code. <a href="http://strategoxt.org/">Stratego</a> (or Stratego/XT, to disambiguate from the board game) is a language for program transformation. The Stratego compiler can return an intermediate representation called the “core” language, as an AST in the ATerm format. I’m planning to write about this interpreter in another blog post soon.</p>

<h1 id="the-implementation">The implementation</h1>

<p>Ok, so here’s what you get from the <code class="highlighter-rouge">aterm</code> crate:</p>

<ol>
  <li>A parser that takes in an text format ATerm string.
    <ul>
      <li>I have <a href="https://gitlab.com/Apanatshka/aterm/issues/10">a</a> <a href="https://gitlab.com/Apanatshka/aterm/issues/4">number</a> <a href="https://gitlab.com/Apanatshka/aterm/issues/5">of</a> <a href="https://gitlab.com/Apanatshka/aterm/issues/6">issues</a> open: basically zero-copy parsing and the other formats.</li>
    </ul>
  </li>
  <li>A printer for the text format. Again, the other formats are todo.</li>
  <li>A factory trait for building ATerms.</li>
  <li>An ATerm trait for matching ATerms.</li>
  <li>Some basics such as the default enum for terms (<code class="highlighter-rouge">Int(i32)</code>, <code class="highlighter-rouge">Real(f32)</code>, <code class="highlighter-rouge">Application(constructor, children)</code>, <code class="highlighter-rouge">List(children)</code>, <code class="highlighter-rouge">Placeholder(placeholder_enum)</code>).</li>
  <li>The <a href="http://homepages.cwi.nl/~daybuild/daily-books/technology/aterm-guide/aterm-guide.html">ATerm programming guide</a> mentions a BLOB term, which I considered an extension point that could be typed in Rust. So you can add more stuff to the term enum with the variant <code class="highlighter-rouge">Blob(your_extension_here)</code>.</li>
  <li>An implementation of the ATerm trait for the above basics.</li>
  <li>A reference counting implementation with factory.</li>
  <li>A second Rc implementation where the factory guarantees maximal sharing.</li>
</ol>

<p>For more details, check out the <a href="https://docs.rs/aterm">docs</a>. (Which I should probably extend a little…)</p>

<h2 id="highlights--things-i-learned">Highlights &amp; Things I learned</h2>

<ol>
  <li>Ideally I would have use higher-kinded types for this ATerm implementation. But Rust doesn’t have that. So I found a way where the <code class="highlighter-rouge">ATerm</code> trait defines an associated type <code class="highlighter-rouge">Rec: Borrow&lt;Self&gt;</code>. That still allows people to implement the <code class="highlighter-rouge">ATerm</code> trait while adding in more of their own things. The basic <code class="highlighter-rouge">rc::ATerm</code> implementation looks like this:
    <div class="language-rust highlighter-rouge"><pre class="highlight"><code>  <span class="k">struct</span> <span class="n">ATerm</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ATermInner</span><span class="o">&lt;</span><span class="nb">Rc</span><span class="o">&lt;</span><span class="n">ATerm</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">B</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre>
    </div>
    <p>Where <code class="highlighter-rouge">ATermInner</code> is a basic implementation that contains a term and a list of annotations.</p>
  </li>
  <li>Using your own library is the only way to make sure it’s actually usable! I had this implementation that compiled a while back, then I started using the factory for the parser, and nothing actually worked out. Then I started to think things over, removed a bunch type parameters, generally simplified things. I’m now a bit unhappy with the allocation characteristics, but the crate isn’t 1.0 yet, I can still tinker with it a little although I don’t want to introduce big breaking changes anymore.</li>
  <li>I had an arena allocation implementation at some point. It was terribly broken, so I had to cut it out. I plan on <a href="https://gitlab.com/Apanatshka/aterm/issues/9">revisiting that idea soon</a> by using someone else’s arena allocation crate.</li>
  <li>While simplifying and trying to get my library usable, I found out a thing I hadn’t really grasped before in the Rust type system: <em>Associated types are unique per trait implementation</em>. So for my <code class="highlighter-rouge">ATerm</code> trait I made the <code class="highlighter-rouge">Rec</code> and <code class="highlighter-rouge">Blob</code> types associative, and that made it much more usable. You see, associated types are easier on Rust’s type inference: Given a fully concrete type there is definitely only one trait implementation possible. And it’s not as limiting for the implementor as you might think. You can still use type parameters in your <code class="highlighter-rouge">impl</code>s:
    <div class="language-rust highlighter-rouge"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">Rec</span><span class="p">,</span> <span class="n">B</span><span class="o">&gt;</span> <span class="n">ATerm</span> <span class="k">for</span> <span class="n">ATermInner</span><span class="o">&lt;</span><span class="n">Rec</span><span class="p">,</span> <span class="n">B</span><span class="o">&gt;</span>
    <span class="n">where</span> <span class="n">Rec</span><span class="p">:</span> <span class="n">Borrow</span><span class="o">&lt;</span><span class="n">ATermInner</span><span class="o">&lt;</span><span class="n">Rec</span><span class="p">,</span> <span class="n">B</span><span class="o">&gt;&gt;</span>
<span class="p">{</span>
    <span class="k">type</span> <span class="n">Rec</span> <span class="o">=</span> <span class="n">Rec</span><span class="p">;</span>
    <span class="k">type</span> <span class="n">Blob</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span>

    <span class="cp">#[inline]</span>
    <span class="k">fn</span> <span class="nf">into_inner</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">ATermInner</span><span class="o">&lt;</span><span class="n">Rec</span><span class="p">,</span> <span class="n">B</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">self</span>
    <span class="p">}</span>
    <span class="cp">#[inline]</span>
    <span class="k">fn</span> <span class="nf">as_inner</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="n">ATermInner</span><span class="o">&lt;</span><span class="nn">Self</span><span class="p">::</span><span class="n">Rec</span><span class="p">,</span> <span class="nn">Self</span><span class="p">::</span><span class="n">Blob</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">self</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
    <p>The only thing I dislike about associated types is how large your where clauses get when you want to add extra constraints. While working on my Stratego interpreter, at some point I had where clauses like this:</p>
    <div class="language-rust highlighter-rouge"><pre class="highlight"><code><span class="n">where</span> <span class="n">F</span><span class="p">:</span> <span class="err">'</span><span class="n">a</span> <span class="o">+</span> <span class="n">ATermFactory</span><span class="o">&lt;</span><span class="err">'</span><span class="n">a</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">ATermRef</span> <span class="o">=</span> <span class="n">A</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="n">A</span><span class="p">:</span> <span class="n">Borrow</span><span class="o">&lt;&lt;</span><span class="n">F</span> <span class="k">as</span> <span class="n">ATermFactory</span><span class="o">&lt;</span><span class="err">'</span><span class="n">a</span><span class="p">,</span> <span class="n">B</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">ATerm</span><span class="o">&gt;</span> <span class="o">+</span> <span class="n">Clone</span><span class="p">,</span>
      <span class="o">&lt;</span><span class="n">F</span> <span class="k">as</span> <span class="n">ATermFactory</span><span class="o">&lt;</span><span class="err">'</span><span class="n">a</span><span class="p">,</span> <span class="n">B</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">ATerm</span><span class="p">:</span> <span class="nb">Eq</span><span class="p">,</span>
      <span class="n">B</span><span class="p">:</span> <span class="err">'</span><span class="n">a</span>
</code></pre>
    </div>
    <p>I was already using type parameter <code class="highlighter-rouge">A</code> so I didn’t have to use <code class="highlighter-rouge">&lt;F as ATermFactory&lt;'a, B&gt;&gt;::ATermRef</code>. I found a slight improvement when I defined type aliases for <code class="highlighter-rouge">ATermRef</code> and <code class="highlighter-rouge">ATerm</code> from a factory. Later I just defined the concrete types I was using with some type aliases (for easy changing later) and went with that. Makes it slightly harder to change them later if I start to depend on concrete parts of the types, but most code was already written in a generic way, so it shouldn’t be too much of a pain. It’s kind of sad that writing generic code is so ugly and sometimes impossible, I like writing code where I only require a minimal contract on what the types need to be capable of.</p>
  </li>
</ol>

<h1 id="what-happened-to-automata">What happened to automata?</h1>

<p>I wrote my last automata blog post in November last year. Since then I’ve been really busy. In the short amounts of spare time I had left, at first I tried to do the benchmarking for the third Finite Automata post. But I couldn’t figure out how to do it right, or maybe it was all in reading the trace output. Basically I’m not that familiar with performance measurement tools yet, and I was mostly  stumped by <em>why</em> my implementation was so much slower than the one I was comparing with (I wasn’t surprised <em>that</em> it was slower, I was comparing to <a href="https://crates.io/crates/aho-corasick">BurntSushi’s <code class="highlighter-rouge">aho-corasick</code></a>, good luck beating his stuff ^^). Since I only had an hour here or there, I couldn’t effectively work on it, so I gave up for a while. When I got a bit of time again, I needed something new and exciting, not something to bash my head against. So that’s why you got ATerms, and soon a post on my Stratego interpreter. I’ll get back to automata afterwards. I think I can also do some performance engineering on the interpreter, so maybe I’ll learn more that way and use that knowledge to finish writing about the Finite Automata. Until then, I hope you can be patient. Or just say: Eh, whatever ¯\_(ツ)_/¯</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>van den Brand, M. G., De Jong, H. A., Klint, P., &amp; Olivier, P. A. (2000). Efficient annotated terms. <em>Software Practice and Experience</em>, 30(3), 259-291.&nbsp;<a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>Steindorfer, M. J., &amp; Vinju, J. J. (2016, March). Performance Modeling of Maximal Sharing. In <em>Proceedings</em> of the 7th ACM/SPEC on <em>International Conference on Performance Engineering</em> (pp. 135-146). ACM.&nbsp;<a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Whatever</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li><a href="mailto:jeff.smits@gmail.com">jeff.smits@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/Apanatshka">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">Apanatshka</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">A web log. Mostly about computer science-y stuff. 
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
