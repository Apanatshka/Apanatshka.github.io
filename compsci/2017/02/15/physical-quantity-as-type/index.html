<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Types, units and quantities</title>
    <meta name="description" content="A web log. Mostly about computer science-y stuff. 
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://blog.jeffsmits.net/compsci/2017/02/15/physical-quantity-as-type/">
    
    <link rel="stylesheet" type="text/css" href="/css/katex.min.css">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Whatever</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Types, units and quantities</h1>
    <p class="post-meta">Feb 15, 2017</p>
  </header>

  <article class="post-content">
    <p><em>edited on 2017-02-16</em></p>

<p>In this post I’d like to shortly discuss an idea I’ve had a long time ago about type systems and 
units of measure. The usual pitch about having units in the type system of a programming language 
starts with a sad story about some space craft crash because different teams used different 
measures of distance. The competing systems are usually 
<a href="https://en.wikipedia.org/wiki/Imperial_units">Imperial</a> vs <del>Rebels</del> 
<a href="https://en.wikipedia.org/wiki/Metric_system"><ins>Metric</ins></a>. Then units in the type system are 
introduced, which is a way to check that only numbers of the exact same unit are used in 
arithmetic<sup id="fnref:arithmetic"><a href="#fn:arithmetic" class="footnote">1</a></sup>. Examples of languages 
with first-class support are 
<a href="https://blogs.msdn.microsoft.com/andrewkennedy/2008/08/29/units-of-measure-in-f-part-one-introducing-units/">F#</a> 
and <a href="https://blogs.oracle.com/projectfortress/entry/fortress_wrapping_up">Fortress</a>.</p>

<p>I got triggered by a recent explanation of how to emulate <a href="https://github.com/jaheba/stuff/blob/master/communicating_intent.md">units of measure as types in 
Rust</a>. This can be done and is 
done in many languages (I think.. citation needed). But if you like Rust I can recommend reading 
the post, because it uses the Rust-specific conversion traits to its advantage as well. So you can 
work generically with the physical quantity <em>Temperature</em>, while the types are actually units of 
measure <em>Fahrenheit</em> and <em>Degrees Celsius</em>.</p>

<p>What I find interesting is that all the successful systems I read about focus on units of measure.
The idea I’d like to explain in this post is unlikely to be original but I haven’t the heart to look
up how much there is written about it. Gah, I’m beating around the bush. Let’s just dive in.</p>

<blockquote>
  <p><strong>EDIT:</strong> Please note that although I was triggered by a Rust-specific post and I’m using Rust
code below, this idea is expressly not based on Rust-specific features. I’m trying to explain it
in a way that would work for almost any programming language.</p>
</blockquote>

<h1 id="the-big-idea">The big idea</h1>

<p><strong>Use <em>physical quantity</em> (e.g. Temperature) as the type instead of a specific <em>unit of measure</em> 
(e.g. centigrade)</strong>.</p>

<p>There’s two ways I can easily think of for implementing this.</p>

<h2 id="normalisation">Normalisation</h2>

<p>The simplest way, that works in almost any type system, is to decide on a normalisation. There are a 
number of problems with this when you do scientific computation<sup id="fnref:normalisation-problems"><a href="#fn:normalisation-problems" class="footnote">2</a></sup>, but I’m 
ignoring those for a second. Let’s just look at some code that does this for temperature. I’ll stay
with Rust as the implementation language:</p>

<div class="language-rust highlighter-rouge"><pre class="highlight"><code><span class="c">// Normalise to whole degrees celsius</span>
<span class="cp">#[derive(Debug,</span> <span class="cp">Clone,</span> <span class="cp">Copy)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">Temperature</span> <span class="p">{</span>
  <span class="n">degC</span><span class="p">:</span> <span class="nb">f64</span><span class="p">,</span> <span class="c">// note how this field is private</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now to introduce units of measure, you have “smart constructors”. These could be:</p>

<div class="language-rust highlighter-rouge"><pre class="highlight"><code><span class="k">impl</span> <span class="n">Temperature</span> <span class="p">{</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">from_celsius</span><span class="p">(</span><span class="n">degrees</span><span class="p">:</span> <span class="nb">f64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Temperature</span> <span class="p">{</span>
    <span class="n">Temperature</span> <span class="p">{</span> <span class="n">degC</span> <span class="o">=</span> <span class="n">degrees</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">from_fahrenheit</span><span class="p">(</span><span class="n">degrees</span><span class="p">:</span> <span class="nb">f64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Temperature</span> <span class="p">{</span>
    <span class="n">Temperature</span> <span class="p">{</span> <span class="n">degC</span> <span class="o">=</span> <span class="p">(</span><span class="n">degrees</span> <span class="o">-</span> <span class="mi">32</span><span class="err">.</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="err">./</span><span class="mi">9</span><span class="err">.</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">to_celsius</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">f64</span> <span class="p">{</span>
    <span class="k">self</span><span class="py">.degC</span>
  <span class="p">}</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">to_fahrenheit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">f64</span> <span class="p">{</span>
    <span class="k">self</span><span class="py">.degC</span> <span class="o">*</span> <span class="mi">9</span><span class="err">./</span><span class="mi">5</span><span class="err">.</span> <span class="o">+</span> <span class="mi">32</span><span class="err">.</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In Rust you would use these as <code class="highlighter-rouge">Temperature::from_celsius(20_f64)</code>. And then you could go nuts with
a compiler plugin to add special syntax that looks more like <code class="highlighter-rouge">20 C</code>. Or something slightly better
and more generic that would work with any units.</p>

<h2 id="late-conversion">Late conversion</h2>

<p>I already alluded to some issues with normalisation<sup id="fnref:normalisation-problems:1"><a href="#fn:normalisation-problems" class="footnote">2</a></sup>. When you have some 
form of case distinction (algebraic data types is what you think of of course, not some silly 
sub-typing hierarchy like OOP) in you type system (<code class="highlighter-rouge">enum</code> in Rust), you can also defer the 
normalisations. You can defer conversion entirely within generic calculations, which seems slightly 
more powerful than the units-as-types approach from the other post. Here’s what it might look like:</p>

<div class="language-rust highlighter-rouge"><pre class="highlight"><code><span class="c">// Normalise to whole degrees celsius</span>
<span class="cp">#[derive(Debug,</span> <span class="cp">Clone,</span> <span class="cp">Copy)]</span>
<span class="k">enum</span> <span class="n">Temperature</span> <span class="p">{</span>
  <span class="nf">DegreesCelsius</span><span class="p">(</span><span class="nb">f64</span><span class="p">),</span>
  <span class="nf">Fahrenheit</span><span class="p">(</span><span class="nb">f64</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Temperature</span> <span class="p">{</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">from_celsius</span><span class="p">(</span><span class="n">degC</span><span class="p">:</span> <span class="nb">f64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Temperature</span> <span class="p">{</span>
    <span class="nf">DegreesCelsius</span><span class="p">(</span><span class="n">degC</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">from_fahrenheit</span><span class="p">(</span><span class="n">fahr</span><span class="p">:</span> <span class="nb">f64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Temperature</span> <span class="p">{</span>
    <span class="nf">Fahrenheit</span><span class="p">(</span><span class="n">fahr</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">to_celsius</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">f64</span> <span class="p">{</span>
    <span class="k">match</span> <span class="k">self</span> <span class="p">{</span>
      <span class="nf">DegreesCelsius</span><span class="p">(</span><span class="n">degC</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">degC</span><span class="p">,</span>
      <span class="nf">Fahrenheit</span><span class="p">(</span><span class="n">fahr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">(</span><span class="n">fahr</span> <span class="o">-</span> <span class="mi">32</span><span class="err">.</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="err">./</span><span class="mi">9</span><span class="err">.</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">to_fahrenheit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">f64</span> <span class="p">{</span>
    <span class="k">match</span> <span class="k">self</span> <span class="p">{</span>
      <span class="nf">DegreesCelsius</span><span class="p">(</span><span class="n">degC</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">degC</span> <span class="o">*</span> <span class="mi">9</span><span class="err">./</span><span class="mi">5</span><span class="err">.</span> <span class="o">+</span> <span class="mi">32</span><span class="err">.</span><span class="p">,</span>
      <span class="nf">Fahrenheit</span><span class="p">(</span><span class="n">fahr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">fahr</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c">/// Implementing addition on temperatures &lt;3</span>
<span class="k">impl</span> <span class="nb">Add</span> <span class="k">for</span> <span class="n">Temperature</span> <span class="p">{</span>
  <span class="k">type</span> <span class="n">Output</span> <span class="o">=</span> <span class="n">Temperature</span><span class="p">;</span>
  
  <span class="k">fn</span> <span class="nf">add</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">Temperature</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Temperature</span> <span class="p">{</span>
    <span class="k">match</span> <span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="nf">DegreesCelsius</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="nf">DegreesCelsius</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nf">DegreesCelsius</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span>
      <span class="p">(</span><span class="nf">Fahrenheit</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="nf">Fahrenheit</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nf">Fahrenheit</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span>
      <span class="p">(</span><span class="nf">DegreesCelsius</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">_</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nf">DegreesCelsius</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">rhs</span><span class="nf">.to_celsius</span><span class="p">()),</span>
      <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="nf">DegreesCelsius</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="nf">DegreesCelsius</span><span class="p">(</span><span class="k">self</span><span class="nf">.to_celsius</span><span class="p">()</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>I think a primary downside of this scheme vs the units-as-types is that it’s less 
extensible<sup id="fnref:overhead"><a href="#fn:overhead" class="footnote">3</a></sup>. An yet, however much I like extensibility, I think about it like this: If 
you want units you probably just want a crate (Rust equivalent of a library) that offers you 
everything you could possibly need. That takes a bit of time, but if everyone just contributes to 
the one crate, you should be able to collect everything you need<sup id="fnref:precision"><a href="#fn:precision" class="footnote">4</a></sup>. It could be that 
simple. Unless I’m overlooking something? Eh, whatever ¯\_(ツ)_/¯</p>

<blockquote>
  <p><strong>EDIT</strong>: But what about all the other features in the Rust type system? What about type
parameters and traits and macros and, heck, why not even compiler plugins. Well.. that another
thing you’ll need to figure out on a per language basis. I suggesting keeping a look out for the
release of the <a href="https://github.com/iliekturtles/uom">uom crate</a>, which is iteratively improving
a units of measure implementation, based on quantities and normalisation actually :)</p>
</blockquote>

<div class="footnotes">
  <ol>
    <li id="fn:arithmetic">
      <p>Addition anyway, I suppose multiplication should always work but just give you a different unit in return.&nbsp;<a href="#fnref:arithmetic" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:normalisation-problems">
      <p>Like when you’re measuring star distances in light-years but the Distance quantity is normalised to meters. And there are other issues with rounding errors. For most systems you can probably use a sufficiently large floating point value though, like, I don’t know, a <a href="https://en.wikipedia.org/wiki/Quadruple-precision_floating-point_format">128-bit floating point</a>?&nbsp;<a href="#fnref:normalisation-problems" class="reversefootnote">&#8617;</a>&nbsp;<a href="#fnref:normalisation-problems:1" class="reversefootnote">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:overhead">
      <p>Or perhaps the low-level devs mostly care about the memory overhead of the enums? Or maybe even about the branching in the code during calculations? In that case you should go with the normalising approach I guess.&nbsp;<a href="#fnref:overhead" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:precision">
      <p>I guess there is the issue of control over precision, which languages with first-class units have better since they can (I think) have any type + unit combination. Maybe we can do something with type parameters.. Hmm, something to ponder/try.&nbsp;<a href="#fnref:precision" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Whatever</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li><a href="mailto:jeff.smits@gmail.com">jeff.smits@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/Apanatshka">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">Apanatshka</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">A web log. Mostly about computer science-y stuff. 
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
