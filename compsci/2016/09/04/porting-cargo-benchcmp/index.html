<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Porting cargo benchcmp</title>
    <meta name="description" content="A web log. Mostly about computer science-y stuff. 
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://Apanatshka.github.io/compsci/2016/09/04/porting-cargo-benchcmp/">
    
    <link rel="stylesheet" type="text/css" href="/css/katex.min.css">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Whatever</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Porting cargo benchcmp</h1>
    <p class="post-meta">Sep 4, 2016</p>
  </header>

  <article class="post-content">
    <p><strong>TL;DR:</strong> I’ve ported the tool <a href="https://crates.io/crates/cargo-benchcmp"><code class="highlighter-rouge">cargo-benchcmp</code></a> from <a href="https://github.com/BurntSushi/cargo-benchcmp/blob/1d23dec5dd3abe3939cfea030162a7dc6461e544/cargo-benchcmp">Python</a> to <a href="https://github.com/BurntSushi/cargo-benchcmp">Rust</a> and added some functionality. There is more to come which is mostly waiting for review in <a href="https://github.com/BurntSushi/cargo-benchcmp/pulls">pull requests</a>.</p>

<p>I’ve been messing around with Rust for a while now, and I found a little utility called <a href="https://github.com/BurntSushi/cargo-benchcmp"><code class="highlighter-rouge">cargo-benchcmp</code></a> by the famous <a href="http://blog.burntsushi.net/about/">BurntSushi (Andrew Gallant)</a>. You may have seen the benchmark comparisons in one of his <a href="http://blog.burntsushi.net/transducers/">blogposts</a> already. I found out that the utility was a nice <a href="https://github.com/BurntSushi/cargo-benchcmp/blob/1d23dec5dd3abe3939cfea030162a7dc6461e544/cargo-benchcmp">single file Python script</a>. Not a quick and dirty hack, but classes and a few docstrings. I was already messing around with some of my own rust code where I wanted to do a comparison between benchmarks, so that’s great. But the tool only worked with comparison of the same tests over time, and I wanted a comparison of the same tests on multiple implementations. So what do you do? Well, it’s a small open source tool so I decided to contribute. That’s what this post is about.</p>

<h1 id="porting-the-tool">Porting the tool</h1>

<p>I’m teaching myself Rust by writing in it, and my Python is a little rusty (heh), so I decided the first thing I’d do was port the tool to Rust. So I set out to find a good crate for handling command line arguments. And I found an implementation for <a href="http://docopt.org/">docopt</a>, which seems like a rather nice initiative. I can recommend the <a href="https://github.com/docopt/docopt.rs">Rust implementation of doctopt</a> because it goes further than the basic API, and uses <code class="highlighter-rouge">rustc-serialize</code> and macros to get you a nice struct with all the command-line arguments with mostly the right types already.</p>

<p>I also grabbed the <a href="https://crates.io/crates/regex"><code class="highlighter-rouge">regex</code></a> crate of course, to take the benchmark results apart. The regex for a line is the benchmark was something I could just copy, but I decided to pick it apart and <a href="https://github.com/BurntSushi/cargo-benchcmp/blob/0512f17d1206f919706e1486e3dca4dd99068a39/src/benchmark.rs#L114-L119">add comments</a>. The rest of the code started out in mostly the same structure as the Python code, with structs and functions instead of classes.</p>

<p>Now for the output I wanted a nice table format and I found another crate for that which is very simple. It’s called <a href="https://crates.io/crates/tabwriter"><code class="highlighter-rouge">tabwriter</code></a> and it’s a port of the Go package for elastic tabstops. Which makes creating a table as simple as putting a <code class="highlighter-rouge">\t</code> (tab) character between you’re columns. Given that that’s what the character was originally intended for, it’s a rather elegant solution.</p>

<p>Grabbing all of these crates with <code class="highlighter-rouge">cargo</code> is very simple, and one of the pleasures of the Rust ecosystem. To make it even easier I did <code class="highlighter-rouge">cargo install cargo-edit</code>, which gives you three extra cargo subcommands: <code class="highlighter-rouge">list</code>, <code class="highlighter-rouge">add</code> and <code class="highlighter-rouge">rm</code>. So I could just <code class="highlighter-rouge">cargo add tabwriter</code> to get the latest version of the crate added to project dependencies. No more manual editing of <code class="highlighter-rouge">Cargo.toml</code>!</p>

<p>Another thing I learnt along the way was that cargo will just dispatch subcommands to whatever available <code class="highlighter-rouge">cargo-subcommand</code> executable on your <code class="highlighter-rouge">PATH</code>. So I didn’t have to do anything special to make this Rust port available to Rust users. You can right now do <code class="highlighter-rouge">cargo install cargo-benchcmp</code>, and have <code class="highlighter-rouge">cargo benchcmp</code> just work.</p>

<p>Something funny to note about the dependencies I’ve mentioned so far – <code class="highlighter-rouge">docopt</code>, <code class="highlighter-rouge">regex</code> and <code class="highlighter-rouge">tabwriter</code> – they’re all written by BurntSushi. I couldn’t have done this Rust port of his tool so easily without his other crates.</p>

<h1 id="comparing-modules">Comparing modules</h1>

<p>In the project where I had benchmarks to compare, I generated different modules with the names of their implementation technique, all with the same benchmarks. This is fairly easy to <a href="https://github.com/Apanatshka/dnfa/blob/5cdb4307a06aee51f2d19f2619e0ff2e5e49af18/benches/basic.rs">set up with a macro</a>. The result is the same benchmark name, with different prefixes for the different implementations. So in the port of <code class="highlighter-rouge">benchcmp</code>, I added an option to provide two module names first, and the one or more files to read. The files would still contain the benchmark results, but the module names would be used to pick the benchmarks to compare.</p>

<h1 id="the-current-interface">The current interface</h1>

<p>Help message:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cargo benchcmp --help
Compares Rust micro-benchmark results.

Usage:
    cargo benchcmp [options] &lt;old&gt; &lt;new&gt;
    cargo benchcmp [options] &lt;old&gt; &lt;new&gt; &lt;file&gt;
    cargo benchcmp -h | --help
    cargo benchcmp --version

The first version takes two files and compares the common benchmarks.

The second version takes two benchmark name prefixes and one benchmark output
file, and compares the common benchmarks (as determined by comparing the
benchmark names with their prefixes stripped). Benchmarks not matching either
prefix are ignored completely.

If benchmark output is sent on stdin, then the second version is used and the
third file parameter is not needed.

Options:
    -h, --help           Show this help message and exit.
    --version            Show the version.
    --threshold &lt;n&gt;      Show only comparisons with a percentage change greater
                         than this threshold.
    --variance           Show the variance of each benchmark.
    --improvements       Show only improvements.
    --regressions        Show only regressions.
</code></pre>
</div>

<p>An example output:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cd aho-corasick
$ cargo bench | cargo benchcmp --variance --threshold 5 dense:: dense_boxed:: -
 name                                dense:: ns/iter               dense_boxed:: ns/iter         diff ns/iter  diff % 
 ac_one_prefix_byte_every_match      112,957 (+/- 1480) (88 MB/s)  150,581 (+/- 814) (66 MB/s)         37,624  33.31% 
 ac_one_prefix_byte_random           16,096 (+/- 292) (621 MB/s)   20,273 (+/- 60) (493 MB/s)           4,177  25.95% 
 ac_ten_bytes                        58,588 (+/- 218) (170 MB/s)   108,092 (+/- 683) (92 MB/s)         49,504  84.50% 
 ac_ten_diff_prefix                  58,601 (+/- 215) (170 MB/s)   108,082 (+/- 712) (92 MB/s)         49,481  84.44% 
 ac_ten_one_prefix_byte_every_match  112,920 (+/- 1454) (88 MB/s)  150,561 (+/- 824) (66 MB/s)         37,641  33.33% 
 ac_ten_one_prefix_byte_random       19,181 (+/- 251) (521 MB/s)   23,684 (+/- 427) (422 MB/s)          4,503  23.48% 
 ac_two_one_prefix_byte_every_match  112,934 (+/- 2037) (88 MB/s)  150,571 (+/- 1618) (66 MB/s)        37,637  33.33% 
 ac_two_one_prefix_byte_random       16,511 (+/- 142) (605 MB/s)   21,009 (+/- 94) (476 MB/s)           4,498  27.24% 
</code></pre>
</div>

<h1 id="things-to-come">Things to come</h1>

<p>I’m not done with this tool just yet. I did open a PR to the original repo and got a great code review from BurntSushi. He published it to <a href="https://crates.io/">crates.io</a> too, and beat me to the punch by posting on Reddit, but I hope this post was still interesting to you. Here’s some things I’ve been working on:</p>

<h2 id="coloured-output">Coloured output</h2>

<p>Already during the first code review I figured out that my Rust port didn’t get the output quite right. The table was already left-justified, whereas the original tool did right-justification of the last two columns. I liked the original output better so I switched <code class="highlighter-rouge">tabwriter</code> for <a href="https://crates.io/crates/prettytable-rs"><code class="highlighter-rouge">prettytable-rs</code></a>, which is a nice ascii table generator. Out of the box it generated a lot of rules as well, but the format can be customised and one without any rules is even available as a preset <code class="highlighter-rouge">prettytable::format::consts::FORMAT_CLEAN</code>. The macros for the rows are well done, though I might have stumbled upon a regression where you <em>have</em> to give each cell the default format <code class="highlighter-rouge">d-&gt;"you cell here"</code> to get it to work.</p>

<p>Anyway, that happened, I added right-justification. But the crate also gives the option to add colours to your table. So a simple change to the code, and now <code class="highlighter-rouge">benchcmp</code> will give you red rows for regressions and green rows for improvements (<a href="https://github.com/BurntSushi/cargo-benchcmp/pull/9">Pull Request</a>). In my experience, this makes the options show only one or the other obsolete, but it doesn’t hurt so it’s still in there.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cd aho-corasick
$ cargo bench | cargo benchcmp --variance dense:: dense_boxed:: -
</code></pre>
</div>
<p><img src="/images/compsci/2016/09/04/porting-cargo-benchcmp/screenshot_coloured_output.png" alt="Coloured output of the tool, with a bold header line, a lot of green (improvement) lines and two read (regression) lines" /></p>

<h2 id="n-way-comparison-plotting">N-way comparison: Plotting</h2>

<p>Warning: This feature may not actually make it into the tool proper. You can find <a href="https://github.com/BurntSushi/cargo-benchcmp/issues/8">the discussion around that on github</a>. For now this functionality lives in a <a href="https://github.com/Apanatshka/cargo-benchcmp/tree/plot">branch</a>.</p>

<p>Comparing two implementations or commits at a time is great for day-to-day use and the table gives you detailed information. But when you just implemented a feature in a few different ways and found another crate that gives the same functionality, you really need an overview of how all of these things compare to each other. So I added a new subcommand <code class="highlighter-rouge">plot</code> to <code class="highlighter-rouge">benchcmp</code> (and moving the table functionality to subcommand <code class="highlighter-rouge">table</code>; I apologise in advance for the breaking change).</p>

<p>The plot command compares by file or by module, any benchmark test that is present in multiple files/modules. It generated images in <code class="highlighter-rouge">target/benchcmp</code>, one file per benchmark, with a barchart/histogram plot + error bars for the variance. To generate the plots it uses <code class="highlighter-rouge">gnuplot</code>, which should be installed separately and put on your <code class="highlighter-rouge">PATH</code>. I suppose that’s a weakness, but it was the easiest way to do this. Any suggestions to cut or simplify that dependency would be much appreciated, but I couldn’t find a pure Rust plotting crate. If you’re wondering, I don’t use the <a href="https://crates.io/crates/gnuplot"><code class="highlighter-rouge">gnuplot</code> crate</a>, though I did try it at first. In the end it was easier to generate a gnuplot script myself than work with the limited subset of the crate, which does shallow bindings anyway. On the upside, I got to learn about gnuplot, which is a very handy (and powerful) tool indeed!</p>

<p><img src="https://cloud.githubusercontent.com/assets/1237863/17133147/362f7c22-5325-11e6-909a-bf76a8ecc85a.png" alt="A bar plot with whiskers that compares benchmark test ac_ten_one_prefix_byte_every_match for all implementations of aho-corasick (dense, dense_boxed, full, full_overlap and sparse)" /></p>

<h2 id="tests">Tests</h2>

<p>One of the things that came up after the first release of the Rust version of <code class="highlighter-rouge">cargo-benchcmp</code> is tests. I kind of didn’t write any… So I <a href="https://github.com/BurntSushi/cargo-benchcmp/issues/3">asked</a> for a little advice on what to test, and got to work. So now I can report that <code class="highlighter-rouge">cargo-benchcmp</code> is pretty well-tested with <a href="https://github.com/BurntSushi/quickcheck"><code class="highlighter-rouge">quickcheck</code></a> for all the unit tests and <a href="https://github.com/nathanross/second_law"><code class="highlighter-rouge">second_law</code></a> for the integration tests (<a href="https://github.com/BurntSushi/cargo-benchcmp/pull/10">Pull Request</a>). So if you need practical examples of quickcheck properties, implementing your own <code class="highlighter-rouge">Arbitrary</code> instances, or integration testing a Rust commandline tool, or if you’re just curious, have a look :)</p>

<h2 id="better-statistics">Better statistics</h2>

<p>There is <a href="https://github.com/BurntSushi/cargo-benchcmp/issues/4">one last issue</a> on the repo for using better statistics when comparing benchmark measurements. I haven’t looked into this one yet. We may need more information than <code class="highlighter-rouge">cargo bench</code> currently provides. Feel free you look into this one yourself dear reader. Just remember to outline your plan in the issue before you start doing major work. I made the mistake not to do that with the plotting feature, and now that work might not survive… But at least it got me a bit more to write about here ^^</p>

<h2 id="real-world-comparisons-with-the-tool">Real world comparisons with the tool</h2>

<p>This post uses only small examples of <code class="highlighter-rouge">cargo benchcmp</code> output. I want to write a longer post on the implementation of finite automata with benchmark comparisons, along with performance traces and optimisations. But that may take some more time because I’m still figuring out how to use <code class="highlighter-rouge">perf</code> and <code class="highlighter-rouge">callgrind</code> etc., and my implementation is still squarely beaten by BurntSushi’s <a href="https://github.com/burntsushi/aho-corasick"><code class="highlighter-rouge">aho-corasick</code></a> crate. But, you know, whatever ¯\_(ツ)_/¯</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Whatever</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li><a href="mailto:jeff.smits@gmail.com">jeff.smits@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/Apanatshka">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">Apanatshka</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">A web log. Mostly about computer science-y stuff. 
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
